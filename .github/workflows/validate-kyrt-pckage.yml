name: "Validate KYRT Package Issue"

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Check issue body
        uses: actions/github-script@v6
        with:
          script: |
            const issueBody = context.payload.issue.body || '';
            // Try to extract the JSON Config URL (we expect the issue form user filled 'URL JSON Config' input)
            // Simple heuristic: find first URL that contains 'kyrt-cdn-package' or looks like raw.githubusercontent
            const urlRegex = /(https?:\/\/[^\s)'"`]+kyrt-cdn-package(?:\.json)?[^\s)'"`]*)/i;
            const match = issueBody.match(urlRegex);
            const jsonUrl = match ? match[1].trim() : null;

            function comment(msg) {
              return github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: msg
              });
            }

            if (jsonUrl) {
              core.info(`Found JSON URL: ${jsonUrl}`);
              // Try fetch and validate JSON
              try {
                const res = await fetch(jsonUrl, { headers: { 'Accept': 'application/json' } });
                if (!res.ok) {
                  await comment(`⚠️ Aku menemukam URL JSON config tetapi saat mencoba mengunduhnya server merespon ${res.status}. Mohon periksa URL raw JSON kamu.`);
                  return;
                }
                const obj = await res.json();
                const missing = [];
                if (!obj.name) missing.push('`name`');
                if (!obj.version) missing.push('`version`');
                if (!obj.includeFile || !Array.isArray(obj.includeFile) || obj.includeFile.length===0) missing.push('`includeFile` (array)');
                if (missing.length) {
                  await comment(`⚠️ JSON config ditemukan, tapi beberapa field wajib hilang atau tidak valid: ${missing.join(', ')}. Mohon perbaiki JSON-mu.`);
                  return;
                }
                // success
                await comment('✅ JSON config valid. Terima kasih! Kami akan memproses paket Anda. (Jika Anda ingin melewatkan form, ini sudah cukup.)');
                return;
              } catch (err) {
                await comment(`⚠️ Gagal memeriksa JSON dari URL: ${err.message}`);
                return;
              }
            } else {
              // No JSON URL found — check required fields in issue body (simple checks)
              // We will look for specific headings / labels produced by the issue form inputs.
              const missing = [];
              function hasField(label) {
                // crude check — ensure label text appears in body with a non-empty value after it
                const regex = new RegExp(label + '\\s*[:\\-\\n\\r]+\\s*([^\\n\\r]+)', 'i');
                return !!issueBody.match(regex);
              }

              // Basic required fields names (these will be present in the issue body generated by the form)
              const checks = [
                { key: 'package_name', label: 'Nama Paket' },
                { key: 'package_version', label: 'Versi Paket' },
                { key: 'npm_link', label: 'Link NPM' },
                { key: 'download_count', label: 'Jumlah Download' },
                { key: 'include_files', label: 'File yang Ingin Di-include' },
                { key: 'is_static', label: 'Apakah Paket Anda Statis' },
                { key: 'reason', label: 'Kenapa Paket Anda Cocok' }
              ];

              for (const c of checks) {
                if (!issueBody.toLowerCase().includes(c.label.toLowerCase())) {
                  missing.push(c.label);
                }
              }

              if (missing.length) {
                await comment(
                  `⚠️ Sepertinya Anda tidak menyediakan JSON Config URL. Mohon lengkapi form: field-field berikut tampak belum terisi atau tidak terdeteksi: ${missing.join(', ')}.\n\nJika Anda sudah mengisi JSON Config URL yang valid, abaikan pesan ini.`
                );
                return;
              } else {
                await comment('✅ Form tampak lengkap. Terima kasih — tim KYRT CDN akan memeriksa paket Anda.');
                return;
              }
            }
